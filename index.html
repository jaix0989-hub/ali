<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸµ AI Playlist Generator</title>

<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#0d0d0d">

<!-- âœ… ÙÙˆÙ†Øª Ù…Ø¯Ø±Ù† -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
  :root {
    --bg: #0d0d0d;
    --card: #181818;
    --border: #2a2a2a;
    --text: #eaeaea;
    --accent: #ffdb4d;
    --spotify-green: #1ed760;
  }
  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    display: grid;
    min-height: 100vh;
    place-items: center;
  }
  .card {
    width: min(780px, 92vw);
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 24px;
    box-shadow: 0 0 40px rgba(0,0,0,.35);
  }
  button {
    width: 100%;
    padding: 14px;
    font-size: 16px;
    border-radius: 10px;
    cursor: pointer;
    border: none;
    font-weight: 600;
    transition: .15s;
  }
  button.spotify {
    background: var(--spotify-green);
    color: #000;
  }
  button.spotify:hover { filter: brightness(1.1); }

  button.yellow {
    background: var(--accent);
    color: #000;
  }
  button.yellow:hover { filter: brightness(1.1); }

  button:disabled {
    opacity: .5;
    cursor: not-allowed;
  }

  textarea, input {
    width: 100%;
    background: #101010;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px;
    color: var(--text);
    font-size: 15px;
  }
  .grid { display: grid; gap: 14px; }
  .row { display: flex; gap: 10px; flex-wrap: wrap; }
  .row > * { flex: 1; }

  #trackList {
    margin-top: 18px;
    max-height: 360px;
    overflow-y: auto;
    border-top: 1px solid #333;
    padding-top: 10px;
  }
  .track {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 7px 0;
  }
  .track img {
    width: 52px; height: 52px; border-radius: 6px;
    background: #222;
  }
  .track .meta {
    line-height: 1.25;
    font-size: 14px;
  }
  .track .artist {
    opacity: 0.7;
    font-size: 13px;
  }

  #loading {
    display: none;
    text-align: center;
    font-weight: 600;
    color: var(--accent);
  }
  .footer {
    margin-top: 14px;
    opacity: .55;
    font-size: 12px;
    text-align: center;
  }
</style>
</head>
<body>

<div class="card">
  <h2 style="margin-top:0; font-size:22px">ğŸµ AI â†’ Spotify Playlist</h2>

  <div class="grid">
    <textarea id="prompt" rows="4" placeholder="Ú†ÛŒ Ù…ÛŒØ®ÙˆØ§ÛŒ Ú¯ÙˆØ´ Ø¨Ø¯ÛŒØŸ"></textarea>

    <div class="row">
      <input id="count" type="number" min="1" max="100" placeholder="ØªØ¹Ø¯Ø§Ø¯ ØªØ±Ú©">
      <input id="title" type="text" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)">
    </div>

    <button id="btnLogin" class="spotify">Û±) Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ</button>
    <button id="btnCreate" class="yellow" disabled>Û²) Ø³Ø§Ø®Øª Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</button>

    <div id="loading">â³ Ø¯Ø±Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...</div>
    <div id="out"></div>
    <div id="trackList"></div>
  </div>

  <div class="footer">Add to Home screen - Developer: Ali Jafari</div>
</div>

<script>
const API_BASE = "https://ali-gpt.jaix0989.workers.dev";

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js');
}

const out = document.getElementById('out');
function log(msg) { out.innerHTML = msg; }

let accessToken = null;
let refreshToken = null;

// âœ… Ø§Ú¯Ø± Ø§Ø² Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ Ø¨Ø±Ú¯Ø´ØªÛŒÙ… â†’ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø² URL Ø¨Ø®ÙˆØ§Ù†ÛŒÙ…
if (location.hash.includes("spotify_token")) {
  const params = new URLSearchParams(location.hash.substring(1));
  accessToken = params.get("spotify_token");
  refreshToken = params.get("refresh");
  localStorage.setItem("spotify_access", accessToken);
  localStorage.setItem("spotify_refresh", refreshToken);
  history.replaceState({}, "", "/");
  log("âœ… Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ Ù…ØªØµÙ„ Ø´Ø¯! Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª Ø¨Ø³Ø§Ø²ÛŒ");
  document.getElementById("btnCreate").disabled = false;
} else {
  accessToken = localStorage.getItem("spotify_access");
  refreshToken = localStorage.getItem("spotify_refresh");
  if (accessToken) {
    document.getElementById("btnCreate").disabled = false;
    log("âœ… Ù‚Ø¨Ù„Ø§Ù‹ Ø¨Ù‡ Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ ÙˆØµÙ„ Ø´Ø¯Ù‡â€ŒØ§ÛŒ. Ø¢Ù…Ø§Ø¯Ù‡â€ŒÙ” Ø³Ø§Ø®Øª Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª!");
  }
}

// âœ… Ù…Ø±Ø­Ù„Ù‡ Û± â€” Ø§ØªØµØ§Ù„ Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ
document.getElementById('btnLogin').addEventListener('click', () => {
  window.location.href = `${API_BASE}/auth/login`;
});


// âœ… Ù…Ø±Ø­Ù„Ù‡ Û² â€” Ø³Ø§Ø®Øª Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª
document.getElementById('btnCreate').addEventListener('click', async () => {
  if (!accessToken) return log("âŒ Ø¨Ù‡ Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ ÙˆØµÙ„ Ù†ÛŒØ³ØªÛŒ.");

  const prompt = document.getElementById('prompt').value.trim();
  if (!prompt) return log("Ù¾Ø±Ø§Ù…Ù¾Øª Ø®Ø§Ù„ÛŒÙ‡!");

  const count = parseInt(document.getElementById('count').value || '5', 10);
  const title = document.getElementById('title').value.trim() || 'AI Playlist';

  log("ğŸ¤– Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø² OpenAI...");

  const r = await fetch(`${API_BASE}/api/create-playlist`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + accessToken
    },
    body: JSON.stringify({
      prompt,
      count,
      title,
      description: `Generated by AI: ${prompt}`
    })
  });

  const j = await r.json();
  if (!j.ok) {
    return log("âŒ Ø®Ø·Ø§: " + (j.error || "failed"));
  }

  // âœ… Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ù…Ù„ Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª + ØªØ±Ú©â€ŒÙ‡Ø§
  let html = `
    <div style="text-align:center">
      <img src="${j.image}" style="width:160px;border-radius:12px" />
      <h3>${j.name}</h3>
      <a class="link" target="_blank" href="${j.playlist_url}">Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª Ø¯Ø± Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ</a>
      <p>${j.added} ØªØ±Ú© Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ âœ…</p>
    </div>
    <hr>
    <div style="display:grid;gap:10px">
  `;

  for (const t of j.tracks) {
    html += `
      <div style="display:flex;align-items:center;gap:12px;background:#1b1d23;padding:8px;border-radius:10px">
        <img src="${t.cover}" style="width:50px;height:50px;border-radius:6px;">
        <div>
          <div><b>${t.name}</b></div>
          <small>${t.artist}</small>
        </div>
      </div>
    `;
  }

  html += "</div>";
  out.innerHTML = html;
});
</script>

</body>
</html>
