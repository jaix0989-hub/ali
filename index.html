<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI â†’ Spotify Playlist</title>

  <!-- ÙÙˆÙ†Øª Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ Ù…Ø§Ù†Ù†Ø¯ -->
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root {
      --bg: #0b0c10;
      --surface: #111319;
      --neon-yellow: #ffe347;
      --neon-teal: #4fffe2;
      --text: #f2f2f2;
      --subtext: #b7b7b7;
      --radius: 14px;
    }

    * {
      box-sizing: border-box;
      font-family: "Plus Jakarta Sans", sans-serif;
    }

    body {
      background: radial-gradient(circle at 20% 10%, #1b1e24 0%, #0b0c10 70%);
      margin: 0;
      padding: 0;
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .card {
      width: min(760px, 94vw);
      background: rgba(15, 17, 22, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: var(--radius);
      padding: 26px;
      backdrop-filter: blur(14px);
      box-shadow: 0 0 25px rgba(255, 230, 0, 0.16);
      animation: cardFade .6s ease-out;
    }

    @keyframes cardFade {
      from { opacity: 0; transform: scale(.94); }
      to   { opacity: 1; transform: scale(1); }
    }

    h2 {
      margin-top: 0;
      font-weight: 700;
      background: linear-gradient(90deg, var(--neon-yellow), var(--neon-teal));
      -webkit-background-clip: text;
      color: transparent;
      font-size: 26px;
    }

    textarea, input {
      width: 100%;
      background: #0c0d11;
      border: 1px solid #282c36;
      border-radius: var(--radius);
      padding: 14px;
      color: var(--text);
      font-size: 15px;
      transition: .2s;
    }

    textarea:focus, input:focus {
      border-color: var(--neon-teal);
      box-shadow: 0 0 6px var(--neon-teal);
      outline: none;
    }

    label {
      font-size: 13px;
      opacity: 0.75;
      display: block;
      margin-bottom: 6px;
    }

    .row {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
    }

    button {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border-radius: var(--radius);
      border: none;
      cursor: pointer;
      font-weight: 600;
      color: black;
      transition: .22s ease;
      letter-spacing: .3px;
    }

    #btnLogin {
      background: #1ed760;
      box-shadow: 0 0 10px #1ed76055;
    }
    #btnLogin:hover { filter: brightness(1.12); transform: translateY(-2px); }

    #btnCreate {
      background: var(--neon-yellow);
      box-shadow: 0 0 12px #ffe34766;
    }
    #btnCreate:hover { filter: brightness(1.1); transform: translateY(-2px); }

    #btnCreate:disabled {
      opacity: .55;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .footer {
      opacity: .55;
      font-size: 12px;
      text-align: center;
      margin-top: 14px;
    }

    .track-list {
      margin-top: 22px;
      border-top: 1px solid #222;
      padding-top: 16px;
      max-height: 350px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--neon-teal) #111;
    }
    .track-list::-webkit-scrollbar {
      width: 7px;
    }
    .track-list::-webkit-scrollbar-thumb {
      background: var(--neon-teal);
      border-radius: 6px;
    }

    .track {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
      animation: fadeUp .4s ease;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .track img {
      width: 56px;
      height: 56px;
      border-radius: 8px;
      object-fit: cover;
      box-shadow: 0 0 10px rgba(255,255,255,.14);
    }

    .track-title {
      font-size: 15px;
      font-weight: 600;
    }
    .track-artist {
      font-size: 13px;
      color: var(--subtext);
    }

    a.link {
      color: var(--neon-teal);
      text-decoration: none;
      font-weight: 600;
    }
    a.link:hover { color: var(--neon-yellow); }
  </style>
</head>

<body>

  <div class="card">
    <h2>ğŸµ Ø³Ø§Ø®Øª Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</h2>

    <div class="grid">
      <div>
        <label>Ù¾Ø±Ø§Ù…Ù¾Øª Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:</label>
        <textarea id="prompt" rows="4" placeholder="Ú†ÛŒ Ù…ÛŒØ®ÙˆØ§ÛŒ Ú¯ÙˆØ´ Ø¨Ø¯ÛŒØŸ"></textarea>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>ØªØ¹Ø¯Ø§Ø¯ Ø¢Ù‡Ù†Ú¯</label>
          <input id="count" type="number" min="1" max="100" placeholder="5" />
        </div>
        <div style="flex:2">
          <label>Ù†Ø§Ù… Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª</label>
          <input id="title" type="text" placeholder="AI Playlist" />
        </div>
      </div>

      <button id="btnLogin">Û±) Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ</button>
      <button id="btnCreate" disabled>Û²) Ø³Ø§Ø®Øª Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª ğŸ§</button>

      <div id="out" class="footer"></div>

      <div id="tracks" class="track-list" style="display:none"></div>
    </div>

    <div class="footer">Add to home screen - Developer: Ali jafari</div>
  </div>

  <!-- âš ï¸ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù‡Ù…Ø§Ù†ÛŒ Ø§Ø³Øª Ú©Ù‡ Ø¯Ø§Ø±ÛŒ â€” Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± -->
  <script>
  /* â›” Ø¨Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ØŒ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡ */
  /* ÙÙ‚Ø· UI Ø¨Ø§Ù„Ø§ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ */
  const API_BASE = "https://ali-gpt.jaix0989.workers.dev";
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js');

  const keyInput = document.getElementById('openaiKey');
  const savedKey = localStorage.getItem('OPENAI_KEY');
  if (savedKey && keyInput) keyInput.value = atob(savedKey);

  keyInput?.addEventListener('change', () => {
    localStorage.setItem('OPENAI_KEY', btoa(keyInput.value.trim()));
  });

  const out = document.getElementById('out');
  function log(msg) { out.innerHTML = msg; }

  async function checkAuth() {
    const r = await fetch(`${API_BASE}/auth/status`);
    const j = await r.json();
    if (j.authed) {
      document.getElementById('btnCreate').disabled = false;
      log(`âœ… Ù…ØªØµÙ„ Ø¨Ù‡ Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ`);
    } else {
      log(`â›” Ù‡Ù†ÙˆØ² Ø¨Ù‡ Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ ÙˆØµÙ„ Ù†ÛŒØ³ØªÛŒ`);
    }
  }
  checkAuth();

  document.getElementById('btnLogin').addEventListener('click', () => {
    window.location.href = `${API_BASE}/auth/login`;
  });

  document.getElementById('btnCreate').addEventListener('click', async () => {
    const apikey = "BACKEND_HERE"; // Ø¨Ø¯ÙˆÙ† ÙˆØ±ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø±
    const prompt = document.getElementById('prompt').value.trim();
    if (!prompt) return log('Ù¾Ø±Ø§Ù…Ù¾Øª Ø®Ø§Ù„ÛŒÙ‡!');
    const count = parseInt(document.getElementById('count').value || '5', 10);
    const title = document.getElementById('title').value.trim() || 'AI Playlist';

    log('â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ OpenAI...');
    const sys = `You are a helpful music expert. Output ONLY a numbered list of songs in the format "Artist - Track".`;
    const user = `Create a playlist matching this prompt: "${prompt}". Number of songs: ${count}.`;

    const resp = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + apikey,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        temperature: 0.7,
        messages: [{ role: 'system', content: sys }, { role: 'user', content: user }]
      })
    });

    if (!resp.ok) return log('âš ï¸ OpenAI error: ' + resp.status);

    const data = await resp.json();
    const text = data.choices?.[0]?.message?.content || '';
    const lines = text.split('\n')
      .map(s => s.replace(/^\s*\d+[\).\-\:]\s*/, '').trim())
      .filter(s => s.includes(' - '));

    if (!lines.length) return log('Ù‡ÛŒÚ†ÛŒ Ø¯Ø±Ù†ÛŒÙˆÙ…Ø¯! Ù¾Ø±Ø§Ù…Ù¾Øª Ø±Ùˆ ÙˆØ§Ø¶Ø­â€ŒØªØ± Ú©Ù†.');

    log('ğŸ¯ Ù„ÛŒØ³Øª Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª Ø¯Ø± Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ...');

    const r2 = await fetch(`${API_BASE}/api/create-playlist`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, description: `Generated by AI`, lines })
    });
    const j2 = await r2.json();
    if (!r2.ok || !j2.ok) return log('Spotify error: ' + (j2.error || 'failed'));

    log(`âœ… Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯ â†’ <a class="link" href="${j2.playlist_url}" target="_blank">Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯Ø± Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ</a> ( ${j2.added} ØªØ±Ú© )`);
  });

  if (window.location.hash.includes('spotify=ok')) {
    history.replaceState({}, document.title, '/');
    checkAuth();
  }
  </script>
</body>
</html>
