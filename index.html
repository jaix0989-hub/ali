<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸµ AI Playlist Generator</title>

<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#0d0d0d">

<!-- âœ… ÙÙˆÙ†Øª Ù…Ø¯Ø±Ù† -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
  :root {
    --bg: #0d0d0d;
    --card: #181818;
    --border: #2a2a2a;
    --text: #eaeaea;
    --accent: #ffdb4d;
    --spotify-green: #1ed760;
  }
  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    display: grid;
    min-height: 100vh;
    place-items: center;
  }
  .card {
    width: min(780px, 92vw);
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 24px;
    box-shadow: 0 0 40px rgba(0,0,0,.35);
  }
  button {
    width: 100%;
    padding: 14px;
    font-size: 16px;
    border-radius: 10px;
    cursor: pointer;
    border: none;
    font-weight: 600;
    transition: .15s;
  }
  button.spotify {
    background: var(--spotify-green);
    color: #000;
  }
  button.spotify:hover { filter: brightness(1.1); }

  button.yellow {
    background: var(--accent);
    color: #000;
  }
  button.yellow:hover { filter: brightness(1.1); }

  button:disabled {
    opacity: .5;
    cursor: not-allowed;
  }

  textarea, input {
    width: 100%;
    background: #101010;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px;
    color: var(--text);
    font-size: 15px;
  }
  .grid { display: grid; gap: 14px; }
  .row { display: flex; gap: 10px; flex-wrap: wrap; }
  .row > * { flex: 1; }

  #trackList {
    margin-top: 18px;
    max-height: 360px;
    overflow-y: auto;
    border-top: 1px solid #333;
    padding-top: 10px;
  }
  .track {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 7px 0;
  }
  .track img {
    width: 52px; height: 52px; border-radius: 6px;
    background: #222;
  }
  .track .meta {
    line-height: 1.25;
    font-size: 14px;
  }
  .track .artist {
    opacity: 0.7;
    font-size: 13px;
  }

  #loading {
    display: none;
    text-align: center;
    font-weight: 600;
    color: var(--accent);
  }
  .footer {
    margin-top: 14px;
    opacity: .55;
    font-size: 12px;
    text-align: center;
  }
</style>
</head>
<body>

<div class="card">
  <h2 style="margin-top:0; font-size:22px">ğŸµ AI â†’ Spotify Playlist</h2>

  <div class="grid">
    <textarea id="prompt" rows="4" placeholder="Ù…Ø«Ù„Ø§Ù‹: Û±Û° ØªØ±Ú© Ø±Ù¾ Ø¢Ø±Ø§Ù…â€ŒØ¨Ø®Ø´ Ø´Ø¨ÛŒÙ‡ Drake + The Weeknd Ø¨Ø§ ØªÙ… Ø´Ø¨Ø§Ù†Ù‡"></textarea>

    <div class="row">
      <input id="count" type="number" min="1" max="100" placeholder="ØªØ¹Ø¯Ø§Ø¯ ØªØ±Ú© (Ù…Ø«Ù„Ø§Ù‹ 12)">
      <input id="title" type="text" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)">
    </div>

    <button id="btnLogin" class="spotify">Û±) Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ</button>
    <button id="btnCreate" class="yellow" disabled>Û²) Ø³Ø§Ø®Øª Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</button>

    <div id="loading">â³ Ø¯Ø±Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...</div>
    <div id="out"></div>
    <div id="trackList"></div>
  </div>

  <div class="footer">Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ÛŒÙ†Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ âœ… | Ø´Ø¨ÛŒÙ‡ Ø§Ù¾ Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ</div>
</div>

<script>
const API = "https://ali-gpt.jaix0989.workers.dev"; // Worker endpoint
const out = document.getElementById('out');
const loading = document.getElementById('loading');
const listBox = document.getElementById('trackList');

let ACCESS_TOKEN = null;
let REFRESH_TOKEN = null;

function log(msg) { out.innerHTML = msg; }

async function checkAuth() {
  const r = await fetch(`${API}/api/status`);
  const j = await r.json();
  if (j.authed) {
    ACCESS_TOKEN = j.access_token;
    document.getElementById('btnCreate').disabled = false;
    log(`âœ… Ù…ØªØµÙ„ Ø¨Ù‡ Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ`);
  } else {
    log("âŒ Ù‡Ù†ÙˆØ² Ø¨Ù‡ Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ Ù…ØªØµÙ„ Ù†ÛŒØ³ØªÛŒ");
  }
}
checkAuth();

document.getElementById('btnLogin').onclick = () =>
  (window.location.href = `${API}/auth/login`);

document.getElementById('btnCreate').onclick = async () => {
  const prompt = document.getElementById('prompt').value.trim();
  if (!prompt) return log("Ù¾Ø±Ø§Ù…Ù¾Øª Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³.");

  const count = parseInt(document.getElementById('count').value || "10");
  const title = document.getElementById('title').value.trim() || "AI Playlist";

  loading.style.display = "block";
  log("");
  listBox.innerHTML = "";

  const resp = await fetch(`${API}/api/create`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt, count, title })
  });
  const data = await resp.json();
  loading.style.display = "none";

  if (!data.ok) return log("Ø®Ø·Ø§: " + data.error);

  log(`âœ… Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯ â†’ <a href="${data.url}" target="_blank">Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯Ø± Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ</a>`);

  listBox.innerHTML = data.tracks.map(t => `
    <div class="track">
      <img src="${t.cover}" />
      <div class="meta">
        <div>${t.name}</div>
        <div class="artist">${t.artist}</div>
      </div>
    </div>
  `).join("");
};

if (location.hash.includes("spotify_token")) {
  const params = new URLSearchParams(location.hash.slice(1));
  ACCESS_TOKEN = params.get("spotify_token");
  REFRESH_TOKEN = params.get("refresh");
  history.replaceState({}, document.title, "/");
  checkAuth();
}
</script>
</body>
</html>
