<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PWA AI Playlist</title>

  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#101012">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto; background:#0d0f12; color:#e6e6e6; margin:0; display:grid; min-height:100vh; place-items:center;}
    .card{width:min(720px,94vw); background:#121419; border:1px solid #222633; border-radius:16px; padding:20px; box-shadow:0 8px 30px rgba(0,0,0,.3)}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    input, textarea, button{width:100%; background:#0c0e13; color:#e6e6e6; border:1px solid #2a2f3d; border-radius:12px; padding:12px; font-size:16px}
    button{cursor:pointer; background:#2d6cdf; border:none}
    button:disabled{opacity:.6; cursor:not-allowed}
    small{opacity:.8}
    .pill{display:inline-block; padding:6px 10px; border:1px dashed #2a2f3d; border-radius:999px; font-size:12px; margin-top:6px}
    .footer{opacity:.6; font-size:12px; margin-top:8px}
    .link{color:#8ab4ff}
    .grid{display:grid; gap:12px}
    label{font-size:12px; opacity:.8}
  </style>
</head>
<body>
  <div class="card">
    <h2 style="margin-top:0">ğŸµ AI â†’ Spotify Playlist</h2>
    <div class="grid">
      <div>
        <label>Ú©Ù„ÛŒØ¯ OpenAI (ÙÙ‚Ø· Ø¨Ø§Ø± Ø§ÙˆÙ„ØŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø±)</label>
        <input id="openaiKey" type="password" placeholder="sk-..." />
        <div><span class="pill">Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage</span></div>
      </div>

      <div>
        <label>Ù¾Ø±Ø§Ù…Ù¾Øª Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª</label>
        <textarea id="prompt" rows="4" placeholder="Ú†ÛŒ Ù…ÛŒØ®ÙˆØ§ÛŒ Ú¯ÙˆØ´ Ø¨Ø¯ÛŒØŸ"></textarea>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>ØªØ¹Ø¯Ø§Ø¯ ØªØ±Ú© (Ù¾ÛŒØ´â€ŒÙØ±Ø¶ 5)</label>
          <input id="count" type="number" min="1" max="100" placeholder="5" />
        </div>
        <div style="flex:2">
          <label>Ø¹Ù†ÙˆØ§Ù† Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª</label>
          <input id="title" type="text" placeholder="AI Playlist"/>
        </div>
      </div>

      <button id="btnLogin">Û±) Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ</button>
      <button id="btnCreate" disabled>Û²) Ø³Ø§Ø®Øª Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª</button>
      <div id="out" class="footer"></div>
    </div>
    <div class="footer"> Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø±Ø§ Ø¨Ù‡ ØµÙØ­Ù‡â€ŒØ§ØµÙ„ÛŒ (Add to Home) Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ØŒ Ø±ÙˆÛŒ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ Ù…Ø«Ù„ Ø§Ù¾ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
  </div>

  <script>
const API_BASE = "https://ali-gpt.jaix0989.workers.dev";

// --- Local token handling ---
let access_token = localStorage.getItem("SPOTIFY_TOKEN") || null;
let refresh_token = localStorage.getItem("SPOTIFY_REFRESH") || null;

// Save OpenAI key (same as Ù‚Ø¨Ù„)
const keyInput = document.getElementById('openaiKey');
const savedKey = localStorage.getItem('OPENAI_KEY');
if (savedKey) keyInput.value = atob(savedKey);
keyInput.addEventListener('change', () => {
  localStorage.setItem('OPENAI_KEY', btoa(keyInput.value.trim()));
});

// UI helpers
const out = document.getElementById("out");
function log(msg) { out.innerHTML = msg; }
const btnLogin = document.getElementById("btnLogin");
const btnCreate = document.getElementById("btnCreate");

// âœ… Handle redirect tokens in URL after Spotify login
(function readTokensFromURL() {
  const hash = window.location.hash;
  if (!hash.includes("spotify_token")) return;
  const params = new URLSearchParams(hash.replace("#", ""));
  access_token = params.get("spotify_token");
  refresh_token = params.get("refresh");
  if (access_token) localStorage.setItem("SPOTIFY_TOKEN", access_token);
  if (refresh_token) localStorage.setItem("SPOTIFY_REFRESH", refresh_token);
  history.replaceState({}, document.title, "/"); // clean URL
})();

// âœ… Check token validity by calling Spotify /me
async function checkAuth() {
  if (!access_token) {
    btnCreate.disabled = true;
    log("Ø¨Ù‡ Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ ÙˆØµÙ„ Ù†ÛŒØ³ØªÛŒ.");
    return;
  }
  const me = await fetch("https://api.spotify.com/v1/me", {
    headers: { Authorization: "Bearer " + access_token }
  });
  if (me.status === 401) {
    log("â³ ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ØŒ Ø¯Ø§Ø±Ù… Ø±ÙØ±Ø´ Ù…ÛŒâ€ŒÚ©Ù†Ù…...");
    await refreshAccessToken();
    return checkAuth();
  }
  const j = await me.json();
  btnCreate.disabled = false;
  log(`Ù…ØªØµÙ„ Ø´Ø¯ÛŒ Ø¨Ù‡ <b>${j.display_name || j.id}</b> âœ…`);
}

async function refreshAccessToken() {
  if (!refresh_token) return log("âš ï¸ Ø±ÙØ±Ø´ ØªÙˆÚ©Ù† Ù†Ø¯Ø§Ø±ÛŒÙ…ØŒ Ø§ÙˆÙ„ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù„Ø§Ú¯ÛŒÙ† Ú©Ù†.");
  const r = await fetch(`${API_BASE}/api/refresh`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ refresh_token })
  });
  const j = await r.json();
  if (!j.ok) return log("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø±ÙØ±Ø´ ØªÙˆÚ©Ù†: " + j.error);
  access_token = j.access_token;
  localStorage.setItem("SPOTIFY_TOKEN", access_token);
  log("ğŸ”„ ØªÙˆÚ©Ù† ØªØ§Ø²Ù‡ Ø´Ø¯ âœ…");
}

// âœ… Login button
btnLogin.addEventListener("click", () => {
  window.location.href = `${API_BASE}/auth/login`;
});

// âœ… Create playlist button
btnCreate.addEventListener("click", async () => {
  const apikey = keyInput.value.trim();
  if (!apikey) return log("Ú©Ù„ÛŒØ¯ OpenAI Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù†.");

  const prompt = document.getElementById("prompt").value.trim();
  if (!prompt) return log("Ù¾Ø±Ø§Ù…Ù¾Øª Ø®Ø§Ù„ÛŒÙ‡!");

  const count = parseInt(document.getElementById("count").value || "5", 10);
  const title = document.getElementById("title").value.trim() || "AI Playlist";

  log("â³ Ø¯Ø§Ø±Ù… Ø§Ø² OpenAI Ù„ÛŒØ³Øª Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù…...");

  const sys = `You are a helpful music expert. Output ONLY a numbered list of songs in the format "Artist - Track".`;
  const user = `Create a playlist: "${prompt}". Song count: ${count}.`;

  const resp = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      Authorization: "Bearer " + apikey,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      model: "gpt-4o-mini",
      temperature: 0.7,
      messages: [
        { role: "system", content: sys },
        { role: "user", content: user }
      ]
    })
  });

  if (!resp.ok) return log("âŒ Ø®Ø·Ø§ Ø§Ø² OpenAI: " + resp.status);
  const data = await resp.json();
  const text = data.choices[0]?.message?.content || '';
  const lines = text.split('\n')
    .map(s => s.replace(/^\s*\d+[\).\-\:]\s*/, '').trim())
    .filter(s => s.includes(" - "));

  if (!lines.length) return log("âš ï¸ Ø®Ø±ÙˆØ¬ÛŒ OpenAI Ù†Ø§Ù…Ø¹ØªØ¨Ø±Ù‡.");

  log("ğŸ¯ Ù„ÛŒØ³Øª Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯ØŒ Ø¯Ø§Ø±Ù… Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª Ù…ÛŒâ€ŒØ³Ø§Ø²Ù…...");

  // Auto-refresh access token before calling backend
  const test = await fetch("https://api.spotify.com/v1/me", {
    headers: { Authorization: "Bearer " + access_token }
  });
  if (test.status === 401) {
    await refreshAccessToken();
  }

  const r2 = await fetch(`${API_BASE}/api/create-playlist`, {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + access_token,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      title,
      description: `Generated by AI - ${prompt}`,
      lines
    })
  });

  const j2 = await r2.json();
  if (!j2.ok) return log("âŒ Ø®Ø·Ø§ Ø§Ø² Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ: " + j2.error);

  log(`âœ… Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯ â†’ <a class="link" href="${j2.playlist_url}" target="_blank">Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯Ø± Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ</a> (${j2.added} ØªØ±Ú©)`);
});

// First run
checkAuth();
</script>

</body>
</html>
