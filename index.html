<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PWA AI Playlist</title>

  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#101012">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto; background:#0d0f12; color:#e6e6e6; margin:0; display:grid; min-height:100vh; place-items:center;}
    .card{width:min(720px,94vw); background:#121419; border:1px solid #222633; border-radius:16px; padding:20px; box-shadow:0 8px 30px rgba(0,0,0,.3)}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    input, textarea, button{width:100%; background:#0c0e13; color:#e6e6e6; border:1px solid #2a2f3d; border-radius:12px; padding:12px; font-size:16px}
    button{cursor:pointer; background:#2d6cdf; border:none}
    button:disabled{opacity:.6; cursor:not-allowed}
    small{opacity:.8}
    .pill{display:inline-block; padding:6px 10px; border:1px dashed #2a2f3d; border-radius:999px; font-size:12px; margin-top:6px}
    .footer{opacity:.6; font-size:12px; margin-top:8px}
    .link{color:#8ab4ff}
    .grid{display:grid; gap:12px}
    label{font-size:12px; opacity:.8}
  </style>
</head>
<body>
  <div class="card">
    <h2 style="margin-top:0">ğŸµ AI â†’ Spotify Playlist</h2>
    <div class="grid">
      <div>
        <label>Ú©Ù„ÛŒØ¯ OpenAI (ÙÙ‚Ø· Ø¨Ø§Ø± Ø§ÙˆÙ„ØŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø±)</label>
        <input id="openaiKey" type="password" placeholder="sk-..." />
        <div><span class="pill">Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage</span></div>
      </div>

      <div>
        <label>Ù¾Ø±Ø§Ù…Ù¾Øª Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª</label>
        <textarea id="prompt" rows="4" placeholder="Ú†ÛŒ Ù…ÛŒØ®ÙˆØ§ÛŒ Ú¯ÙˆØ´ Ø¨Ø¯ÛŒØŸ"></textarea>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>ØªØ¹Ø¯Ø§Ø¯ ØªØ±Ú© (Ù¾ÛŒØ´â€ŒÙØ±Ø¶ 5)</label>
          <input id="count" type="number" min="1" max="100" placeholder="5" />
        </div>
        <div style="flex:2">
          <label>Ø¹Ù†ÙˆØ§Ù† Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª</label>
          <input id="title" type="text" placeholder="AI Playlist"/>
        </div>
      </div>

      <button id="btnLogin">Û±) Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ</button>
      <button id="btnCreate" disabled>Û²) Ø³Ø§Ø®Øª Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª</button>
      <div id="out" class="footer"></div>
    </div>
    <div class="footer"> Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø±Ø§ Ø¨Ù‡ ØµÙØ­Ù‡â€ŒØ§ØµÙ„ÛŒ (Add to Home) Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ØŒ Ø±ÙˆÛŒ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ Ù…Ø«Ù„ Ø§Ù¾ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
  </div>

  <script>
const API_BASE = "https://ali-gpt.jaix0989.workers.dev";

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js');
}

const out = document.getElementById('out');
function log(msg) { out.innerHTML = msg; }

let accessToken = null;
let refreshToken = null;

// âœ… Ø§Ú¯Ø± Ø§Ø² Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ Ø¨Ø±Ú¯Ø´ØªÛŒÙ… â†’ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø² URL Ø¨Ø®ÙˆØ§Ù†ÛŒÙ…
if (location.hash.includes("spotify_token")) {
  const params = new URLSearchParams(location.hash.substring(1));
  accessToken = params.get("spotify_token");
  refreshToken = params.get("refresh");
  localStorage.setItem("spotify_access", accessToken);
  localStorage.setItem("spotify_refresh", refreshToken);
  history.replaceState({}, "", "/");
  log("âœ… Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ Ù…ØªØµÙ„ Ø´Ø¯! Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª Ø¨Ø³Ø§Ø²ÛŒ");
  document.getElementById("btnCreate").disabled = false;
} else {
  accessToken = localStorage.getItem("spotify_access");
  refreshToken = localStorage.getItem("spotify_refresh");
  if (accessToken) {
    document.getElementById("btnCreate").disabled = false;
    log("âœ… Ù‚Ø¨Ù„Ø§Ù‹ Ø¨Ù‡ Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ ÙˆØµÙ„ Ø´Ø¯Ù‡â€ŒØ§ÛŒ. Ø¢Ù…Ø§Ø¯Ù‡â€ŒÙ” Ø³Ø§Ø®Øª Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª!");
  }
}

// âœ… Ù…Ø±Ø­Ù„Ù‡ Û± â€” Ø§ØªØµØ§Ù„ Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ
document.getElementById('btnLogin').addEventListener('click', () => {
  window.location.href = `${API_BASE}/auth/login`;
});


// âœ… Ù…Ø±Ø­Ù„Ù‡ Û² â€” Ø³Ø§Ø®Øª Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª
document.getElementById('btnCreate').addEventListener('click', async () => {
  if (!accessToken) return log("âŒ Ø¨Ù‡ Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ ÙˆØµÙ„ Ù†ÛŒØ³ØªÛŒ.");

  const prompt = document.getElementById('prompt').value.trim();
  if (!prompt) return log("Ù¾Ø±Ø§Ù…Ù¾Øª Ø®Ø§Ù„ÛŒÙ‡!");

  const count = parseInt(document.getElementById('count').value || '5', 10);
  const title = document.getElementById('title').value.trim() || 'AI Playlist';

  log("ğŸ¤– Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø² OpenAI...");

  const r = await fetch(`${API_BASE}/api/create-playlist`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + accessToken
    },
    body: JSON.stringify({
      prompt,
      count,
      title,
      description: `Generated by AI: ${prompt}`
    })
  });

  const j = await r.json();
  if (!j.ok) {
    return log("âŒ Ø®Ø·Ø§: " + (j.error || "failed"));
  }

  // âœ… Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ù…Ù„ Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª + ØªØ±Ú©â€ŒÙ‡Ø§
  let html = `
    <div style="text-align:center">
      <img src="${j.image}" style="width:160px;border-radius:12px" />
      <h3>${j.name}</h3>
      <a class="link" target="_blank" href="${j.playlist_url}">Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª Ø¯Ø± Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ</a>
      <p>${j.added} ØªØ±Ú© Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ âœ…</p>
    </div>
    <hr>
    <div style="display:grid;gap:10px">
  `;

  for (const t of j.tracks) {
    html += `
      <div style="display:flex;align-items:center;gap:12px;background:#1b1d23;padding:8px;border-radius:10px">
        <img src="${t.cover}" style="width:50px;height:50px;border-radius:6px;">
        <div>
          <div><b>${t.name}</b></div>
          <small>${t.artist}</small>
        </div>
      </div>
    `;
  }

  html += "</div>";
  out.innerHTML = html;
});
</script>


</body>
</html>
