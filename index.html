<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PWA AI Playlist</title>

  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#101012">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto; background:#0d0f12; color:#e6e6e6; margin:0; display:grid; min-height:100vh; place-items:center;}
    .card{width:min(720px,94vw); background:#121419; border:1px solid #222633; border-radius:16px; padding:20px; box-shadow:0 8px 30px rgba(0,0,0,.3)}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    input, textarea, button{width:100%; background:#0c0e13; color:#e6e6e6; border:1px solid #2a2f3d; border-radius:12px; padding:12px; font-size:16px}
    button{cursor:pointer; background:#2d6cdf; border:none}
    button:disabled{opacity:.6; cursor:not-allowed}
    small{opacity:.8}
    .pill{display:inline-block; padding:6px 10px; border:1px dashed #2a2f3d; border-radius:999px; font-size:12px; margin-top:6px}
    .footer{opacity:.6; font-size:12px; margin-top:8px}
    .link{color:#8ab4ff}
    .grid{display:grid; gap:12px}
    label{font-size:12px; opacity:.8}
  </style>
</head>
<body>
  <div class="card">
    <h2 style="margin-top:0">ğŸµ AI â†’ Spotify Playlist</h2>
    <div class="grid">
      <div>
        <label>Ú©Ù„ÛŒØ¯ OpenAI (ÙÙ‚Ø· Ø¨Ø§Ø± Ø§ÙˆÙ„ØŒ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)</label>
        <input id="openaiKey" type="password" placeholder="sk-..." />
        <div><span class="pill">Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage</span></div>
      </div>
      <div>
        <label>Ù¾Ø±Ø§Ù…Ù¾Øª Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª</label>
        <textarea id="prompt" rows="4" placeholder="Ù…Ø«Ù„Ø§Ù‹: Û¸ ØªØ±Ú© Ù‡ÛŒÙ¾â€ŒÙ‡Ø§Ù¾ Ø¨Ø§ ØªÙ… Ø§Ù†Ø±Ú˜ÛŒ ØµØ¨Ø­Ú¯Ø§Ù‡ÛŒØŒ Ù…Ø«Ù„ Kendrick + J. ColeØŒ Ø§Ø² Û²Û°Û±8 Ø¨Ù‡ Ø¨Ø¹Ø¯"></textarea>
      </div>
      <div class="row">
        <div style="flex:1">
          <label>ØªØ¹Ø¯Ø§Ø¯ ØªØ±Ú© (Ù¾ÛŒØ´â€ŒÙØ±Ø¶ 5)</label>
          <input id="count" type="number" min="1" max="100" placeholder="5" />
        </div>
        <div style="flex:2">
          <label>Ø¹Ù†ÙˆØ§Ù† Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª</label>
          <input id="title" type="text" placeholder="AI Playlist"/>
        </div>
      </div>
      <button id="btnLogin">Û±) Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ</button>
      <button id="btnCreate" disabled>Û²) Ø³Ø§Ø®Øª Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª</button>
      <div id="out" class="footer"></div>
    </div>
    <div class="footer">PWA: Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø±Ø§ Ø¨Ù‡ ØµÙØ­Ù‡â€ŒØ§ØµÙ„ÛŒ (Add to Home) Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ØŒ Ø±ÙˆÛŒ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ Ù…Ø«Ù„ Ø§Ù¾ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
  </div>

  <script>
  const API_BASE = "https://ali-gpt.jaix0989.workers.dev";

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js');
  }

  const keyInput = document.getElementById('openaiKey');
  const savedKey = localStorage.getItem('OPENAI_KEY');
  if (savedKey) keyInput.value = atob(savedKey);

  keyInput.addEventListener('change', () => {
    localStorage.setItem('OPENAI_KEY', btoa(keyInput.value.trim()));
  });

  const out = document.getElementById('out');
  function log(msg) { out.innerHTML = msg; }

  async function checkAuth() {
    const r = await fetch(`${API_BASE}/auth/status`);
    const j = await r.json();
    if (j.authed) {
      document.getElementById('btnCreate').disabled = false;
      log(`Ù…ØªØµÙ„ Ø¨Ù‡ Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† <b>${j.me?.display_name || j.me?.id}</b>. Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§ÛŒ!`);
    } else {
      log('Ø¨Ù‡ Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ ÙˆØµÙ„ Ù†ÛŒØ³ØªÛŒ.');
    }
  }
  checkAuth();

  document.getElementById('btnLogin').addEventListener('click', () => {
    window.location.href = `${API_BASE}/auth/login`;
  });

  document.getElementById('btnCreate').addEventListener('click', async () => {
    const apikey = keyInput.value.trim();
    if (!apikey) return log('Ú©Ù„ÛŒØ¯ OpenAI Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù†.');

    const prompt = document.getElementById('prompt').value.trim();
    if (!prompt) return log('Ù¾Ø±Ø§Ù…Ù¾Øª Ø®Ø§Ù„ÛŒÙ‡!');
    const count = parseInt(document.getElementById('count').value || '5', 10);
    const title = document.getElementById('title').value.trim() || 'AI Playlist';

    log('Ø¯Ø§Ø±Ù… Ø§Ø² OpenAI Ù„ÛŒØ³Øª Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù…...');

    const sys = `You are a helpful music expert. Output ONLY a numbered list of songs in the format "Artist - Track". No extra text.`;
    const user = `Create a playlist matching this prompt: "${prompt}". Number of songs: ${count}. Return only the list.`;

    const resp = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + apikey,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        temperature: 0.7,
        messages: [
          { role: 'system', content: sys },
          { role: 'user', content: user }
        ]
      })
    });

    if (!resp.ok) {
      return log('OpenAI error: ' + resp.status);
    }
    const data = await resp.json();
    const text = data.choices?.[0]?.message?.content || '';
    const lines = text.split('\n')
      .map(s => s.replace(/^\s*\d+[\).\-\:]\s*/, '').trim())
      .filter(s => s && s.includes(' - '));

    if (!lines.length) return log('Ù‡ÛŒÚ†ÛŒ Ø§Ø² OpenAI Ø¯Ø±Ù†ÛŒÙˆÙ…Ø¯! Ù¾Ø±Ø§Ù…Ù¾ØªØª Ø±Ùˆ ÙˆØ§Ø¶Ø­â€ŒØªØ± Ú©Ù†.');

    log('Ù„ÛŒØ³Øª Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯. Ø¯Ø§Ø±Ù… Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ Ù…ÛŒâ€ŒØ³Ø§Ø²Ù…...');

    const r2 = await fetch(`${API_BASE}/api/create-playlist`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        title,
        description: `Generated by AI from prompt: ${prompt}`,
        lines
      })
    });
    const j2 = await r2.json();
    if (!r2.ok || !j2.ok) {
      return log('Spotify error: ' + (j2.error || 'failed'));
    }
    log(`Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯ âœ… â†’ <a class="link" href="${j2.playlist_url}" target="_blank">Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯Ø± Ø§Ø³Ù¾Ø§ØªÛŒÙØ§ÛŒ</a> ( ${j2.added} ØªØ±Ú© )`);
  });

  if (window.location.hash.includes('spotify=ok')) {
    history.replaceState({}, document.title, '/');
    checkAuth();
  }
</script>

</body>
</html>
